# CVE-2024-2887 (Type Confusion in WebAssembly)

## Setup

- Ubuntu 24.04.1 LTS
- [28877c5520793115f8272876a2581b2e5068cffa](https://chromium.googlesource.com/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa) (2024.03.21.)

[setup.zsh](./setup.zsh)

## Analysis

### Decoding type section in WebAssembly module

Wasm module에서 사용자가 정의한 custom type들의 정보는 type section에 저장된다. Wasm module을 decode하는 작업은 [`DecodeSection()`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=417)에서 수행하고, type section은 [`DecodeTypeSection()`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=621)에서 처리된다.

`DecodeTypeSection()`에서는 먼저 type section에 저장된 type들의 개수가 [`kV8MaxWasmTypes`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/wasm-limits.h;l=29) (`== 1000000`)를 초과하지 않는지 [`consume_count()`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=1847)로 검사한다. 초과하면 `consume_count()`는 0을 return하고, 초과하지 않으면 type들의 개수를 return한다. `consume_count()`의 return value는 [`types_count`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=623)에 저장된다. 이때 recursive type group은 한 개의 type으로 취급된다. 그리고 나서 `types_count`만큼 [반복문을 돌며](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=625) 각각의 type들을 decode한다.

[`initial_size`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=628)에는 현재까지 `module_->types`에 저장된 type들의 개수가 들어간다.

`kind`가 [`kWasmRecursiveTypeGroupCode`인 경우](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=629), [`group_size`가 `kV8MaxWasmTypes`를 초과하지 않는지](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=634), 그리고 [`initial_size + group_size`가 `kV8MaxWasmTypes`를 초과하지 않는지](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=637) 차례로 검사한다. 두 검사를 통과하면 `module_->types`의 size를 [`initial_size + group_size`로 확장](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=648)하고, group의 `type`들을 [`module_->types`에 저장](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=654)한다.

`kind`가 [`kWasmRecursiveTypeGroupCode`가 아닌 경우](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=662), `module_->types`를 [`initial_size + 1`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=665)로 확장하고 그 자리에 [`type`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/module-decoder-impl.h;l=669)을 저장한다.

### Root cause

`DecodeTypeSection()`에서 `kind`가 `kWasmRecursiveTypeGroupCode`이 아닌 경우, 즉 recursive type group이 아닌 type을 추가할 때는 size check가 없다. 따라서 `types_count`만 `kV8MaxWasmTypes`를 초과하지 않으면 `module_->types`에 `kV8MaxWasmTypes`보다 많은 type들을 저장할 수 있다.

### Proof of concept

[poc_no_rec.js](./poc_no_rec.js)

![image](https://github.com/user-attachments/assets/91da6428-b7c2-4bf9-aac4-b02b7bfd321e)

Recursive group을 사용하지 않으면 그냥 `kV8MaxWasmTypes + 1` 만큼의 type들을 정의하려고 시도하는 상황이기 때문에 에러가 발생한다.

[poc_rec.js](./poc_rec.js)

![image](https://github.com/user-attachments/assets/12fc5ce4-18be-47f8-b676-8e2aef7f7659)

`kV8MaxWasmTypes` 만큼의 type들을 recursive type group으로 묶으면 한 개의 type으로 취급되기 때문에 `types_count`는 2가 되고 `initial_size`는 `kV8MaxWasmTypes`가 된다. 이 상태에서 recursive type group이 아닌 type을 정의하면 `module_->types`의 size가 `initial_size + 1`, 즉 `kV8MaxWasmTypes + 1`로 확장되고 그 자리에 type이 저장되어 정상적으로 Wasm module이 생성된다.

### Patch

> [wasm - Check for type-definition count limit](https://chromium.googlesource.com/v8/v8/+/b852ad701db21d6db5b34e66f4ec1cdccd2ec4d4) (2024.03.21.)

## Exploitation

### WebAssembly type confusion

[`HeapType::Representation`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/value-type.h;l=61)은 Wasm module의 default type들에 해당하는 index를 저장하고 있다. 이 default type들은 `kV8MaxWasmTypes`부터 시작되는 index들을 reserve하고 있는데, 버그로 인해 `kV8MaxWasmTypes` 이상의 index에 사용자가 정의한 type을 저장할 수 있기 때문에 type confusion이 발생한다. 예를 들어, index가 `kV8MaxWasmTypes + 3`인 type은 [`kStruct`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/value-type.h;l=65)라는 전제를 가지고 있는데, 실제로는 사용자가 정의한 다른 type에 `kStruct`처럼 접근하게 되어 문제가 생길 수 있다.

Wasm object의 type casting을 수행하는 [`kExprRefCast`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/function-body-decoder-impl.h;l=5097) expression을 처리할 때, object의 type과 cast하려는 `target_type` 간에 casting이 가능한지 검사하는 과정이 있다. 이 작업은 [`IsSameTypeHierarchy()`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/wasm-subtyping.cc;l=837)에서 처리하는데, 두 type에 대해 [`NullSentinelImpl()`](https://source.chromium.org/chromium/v8/v8/+/28877c5520793115f8272876a2581b2e5068cffa:src/wasm/wasm-subtyping.cc;l=99)을 호출한 결과, 즉 hierarchy가 같으면 `true`를 반환한다.

예를 들어, 어떤 object를 `kI31`로 cast하고 싶다면, `kI31`은 `kNone`과 hierarchy가 같기 때문에 버그를 이용하여 `kNone`에 해당하는 index (`== kV8MaxWasmTypes + 13`)에 custom type을 저장하면 그 type으로부터 `kI31`로 cast할 수 있게 된다. 만약 custom type이 실제로는 `kI31`과 hierarchy가 같지 않다면 type confusion이 발생하게 된다.

### Implementing primitives

Wasm에서 임의의 두 object간에 type confusion을 발생시킬 수 있기 때문에 이를 이용하여 exploit primitive들을 얻을 수 있다. `kWasmAnyRef` type을 `kWasmI32`로 cast하면 object의 주소를 구하는 `addrof` primitive가 되고, `kWasmI64` type을 `kWasmAnyRef`로 cast해서 dereference하여 값을 읽거나 쓰면 AAR / AAW primitive가 된다.

### Escaping V8 sandbox

> [Escaping V8 Sandbox via RegExp Bytecode (Chromium < 125.0.6422.60, V8 < 12.5.56)](https://h0meb0dy.github.io/2024/12/10/Escaping-V8-Sandbox-via-RegExp-Bytecode/)

[pwn.js](./pwn.js)

![image](https://github.com/user-attachments/assets/7125a68a-505b-4148-8d04-1eb83ad8bcb9)

## References

- [Stable Channel Update for Desktop (Tuesday, March 26, 2024) - Chrome Releases](https://chromereleases.googleblog.com/2024/03/stable-channel-update-for-desktop_26.html)
- [Pwn2Own 2024 - wasm type confusion from insufficient type section validation - Chromium Issues](https://issues.chromium.org/issues/330588502)
- [Pwn2Own 2024 - v8 wasm type confusion RCE -- umbrella bug - Chromium Issues](https://issues.chromium.org/issues/330575498)
- [CVE-2024-2887: A Pwn2Own Winning Bug in Google Chrome - Zero Day Initiative](https://www.zerodayinitiative.com/blog/2024/5/2/cve-2024-2887-a-pwn2own-winning-bug-in-google-chrome)
